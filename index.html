<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>å†™çœŸãƒ“ãƒ³ã‚´ 4x4ï¼ˆIndexedDB å®Œå…¨ç‰ˆï¼‰</title>

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<style>
* { box-sizing: border-box; }

html, body {
    margin: 0;
    padding: 0;
    width: 100%;
    min-height: 100dvh;
    font-family: sans-serif;
    overflow-x: hidden;
    background: #fff;
}

h1 {
    margin: 8px 0;
    text-align: center;
    font-size: 20px;
}

/* ãƒ¦ãƒ¼ã‚¶ãƒ¼å */
#usernameArea {
    width: 100%;
    max-width: 500px;
    margin: 4px auto 10px auto;
    text-align: center;
}
#usernameInput {
    width: 80%;
    padding: 6px;
    font-size: 14px;
    border-radius: 4px;
    border: 1px solid #ccc;
}

/* ãƒ“ãƒ³ã‚´ */
#bingo {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 6px;
    width: 100%;
    max-width: 100%;
    margin: 0 auto;
}

/* ãƒã‚¹ */
.cell {
    border: 1px solid #ccc;
    border-radius: 6px;
    padding: 6px;
    background: #fafafa;
    display: flex;
    flex-direction: column;
    align-items: center;
}
.cell.completed {
    background: #d1ffd1;
    border: 2px solid #4caf50;
}

/* ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆtextareaï¼‰ */
.keyword {
    width: 100%;
    font-size: 12px;
    padding: 4px;
    border: 1px solid #ccc;
    border-radius: 4px;

    resize: none;
    overflow: hidden;

    white-space: normal;
    word-break: break-word;
    line-height: 1.2;

    min-height: 24px;
    margin-bottom: 4px;
}

/* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒ */
.preview {
    width: 100%;
    max-width: 90px;
    height: 90px;
    object-fit: cover;
    border-radius: 4px;
    background: #eee;
}

/* ãƒœã‚¿ãƒ³ */
.btn-small {
    margin-top: 4px;
    padding: 4px 6px;
    font-size: 11px;
}

.controls {
    padding: 10px;
    text-align: center;
}
</style>
</head>

<body>

<h1>ğŸ“¸ å†™çœŸãƒ“ãƒ³ã‚´ï¼ˆ4Ã—4ï¼‰</h1>

<!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼åæ¬„ -->
<div id="usernameArea">
    <label>ãƒ¦ãƒ¼ã‚¶ãƒ¼åï¼š</label>
    <input type="text" id="usernameInput" placeholder="åå‰ã‚’å…¥åŠ›">
</div>

<!-- ãƒ“ãƒ³ã‚´ -->
<div id="bingo"></div>

<!-- JSON ãƒœã‚¿ãƒ³ -->
<div class="controls">
    <button onclick="exportData()">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆJSONï¼‰</button>
    <input type="file" id="importFile" accept="application/json" style="display:none" onchange="importData(event)">
    <button onclick="document.getElementById('importFile').click()">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
</div>



<script>
/* ================================
   åŸºæœ¬ãƒ‡ãƒ¼ã‚¿
================================ */
let bingoData = [];

const defaultKeywords = [
    "ãã‚Œã„ãªæ™¯è‰²",
    "ãŠã„ã—ãã†ãªã‚‚ã®",
    "èª°ã‹ã®ç¬‘é¡”",
    "å…ƒæ°—ãªãŠã˜ã„ã¡ã‚ƒã‚“ï¼ˆãŠã°ã‚ã¡ã‚ƒã‚“ï¼‰",
    "å¤–æ¥æ¤ç‰©ï¼ˆç”Ÿç‰©ï¼‰",
    "æ˜”ã®æš®ã‚‰ã—ã‚’æ„Ÿã˜ã‚‹ã‚‚ã®",
    "ã€‡ã€‡ã«è¦‹ãˆãŸé›²",
    "é‡Œå±±ã®é¦™ã‚Š",
    "ã»ã£ã“ã‚Šã™ã‚‹ã‚‚ã®",
    "ãã™ã£ã¨ç¬‘ãˆã‚‹ã‚‚ã®",
    "æ–°ã—ã„å»ºç‰©ã€ã‚‚ã®",
    "å¤ã„å»ºç‰©ã€ã‚‚ã®",
    "æ­´å²ã‚’æ„Ÿã˜ã‚‹ã‚‚ã®",
    "ãªã‚“ã¨ãªãƒ¼ãè‰²",
    "å…¨ä½“ï¼ˆåºƒã„ï¼‰ã®æ™¯è‰²",
    ""
];


/* ================================
   IndexedDB ï¼ˆç”»åƒä¿å­˜ç”¨ï¼‰
================================ */
function openDB() {
    return new Promise((resolve, reject) => {
        const req = indexedDB.open("photoBingoDB", 1);

        req.onerror = () => reject(req.error);
        req.onsuccess = () => resolve(req.result);

        req.onupgradeneeded = (event) => {
            const db = event.target.result;
            if (!db.objectStoreNames.contains("images")) {
                db.createObjectStore("images");
            }
        };
    });
}

function saveImageToDB(id, data) {
    return openDB().then(db => {
        const tx = db.transaction("images", "readwrite");
        tx.objectStore("images").put(data, id);
    });
}

function getImageFromDB(id) {
    return openDB().then(db => {
        return new Promise((resolve, reject) => {
            const tx = db.transaction("images", "readonly");
            const req = tx.objectStore("images").get(id);
            req.onsuccess = () => resolve(req.result);
            req.onerror = () => reject(req.error);
        });
    });
}


/* ================================
   localStorage èª­ã¿æ›¸ã
================================ */
function loadData() {
    const saved = localStorage.getItem("photoBingo4x4");
    if (saved) {
        bingoData = JSON.parse(saved);
    } else {
        bingoData = defaultKeywords.map(k => ({ keyword: k, image: null, completed: false }));
    }
}

function saveData() {
    localStorage.setItem("photoBingo4x4", JSON.stringify(bingoData));
}


/* ================================
   ãƒ¦ãƒ¼ã‚¶ãƒ¼åã®ä¿å­˜
================================ */
function loadUserName() {
    const name = localStorage.getItem("photoBingoUserName");
    if (name) document.getElementById("usernameInput").value = name;
}

document.addEventListener("input", () => {
    localStorage.setItem("photoBingoUserName",
        document.getElementById("usernameInput").value
    );
});


/* ================================
   è‡ªå‹•é«˜ã•èª¿æ•´
================================ */
function autoResize(el) {
    el.style.height = "auto";
    el.style.height = el.scrollHeight + "px";
}


/* ================================
   åœ§ç¸® â†’ IndexedDB ä¿å­˜
================================ */
function compressAndSaveImage(file, index) {
    return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (event) => {
            const img = new Image();
            img.onload = () => {
                // åœ§ç¸®
                const maxWidth = 600;
                const scale = maxWidth / img.width;

                const canvas = document.createElement("canvas");
                canvas.width = Math.min(img.width, maxWidth);
                canvas.height = img.height * scale;

                const ctx = canvas.getContext("2d");
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                const base64 = canvas.toDataURL("image/jpeg", 0.8);

                // IndexedDB ã«ä¿å­˜
                saveImageToDB(index, base64).then(() => resolve(base64));
            };
            img.src = event.target.result;
        };
        reader.readAsDataURL(file);
    });
}


/* ================================
   æç”»å‡¦ç†
================================ */
function render() {
    const board = document.getElementById("bingo");
    board.innerHTML = "";

    bingoData.forEach((cell, index) => {
        const div = document.createElement("div");
        div.className = "cell" + (cell.completed ? " completed" : "");

        /* --- textarea --- */
        const input = document.createElement("textarea");
        input.className = "keyword";
        input.value = cell.keyword;

        input.oninput = (e) => {
            bingoData[index].keyword = e.target.value;
            autoResize(input);
            saveData();
        };

        setTimeout(() => autoResize(input), 0);
        div.appendChild(input);


        /* --- ç”»åƒ --- */
        const img = document.createElement("img");
        img.className = "preview";

        if (cell.image !== null) {
            getImageFromDB(index).then(data => {
                img.src = data || "";
            });
        }

        div.appendChild(img);


        /* --- å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ --- */
        const fileInput = document.createElement("input");
        fileInput.type = "file";
        fileInput.accept = "image/*";
        fileInput.capture = "environment";
        fileInput.style.display = "none";

        fileInput.onchange = (event) => {
            const file = event.target.files?.[0];
            if (!file) return;

            compressAndSaveImage(file, index).then(base64 => {
                bingoData[index].image = true; // ç”»åƒã‚ã‚Šãƒ•ãƒ©ã‚°
                saveData();
                render();
            });
        };

        const btn = document.createElement("button");
        btn.className = "btn-small";
        btn.textContent = "å†™çœŸã‚’æ’®ã‚‹/é¸ã¶";
        btn.onclick = () => fileInput.click();

        div.appendChild(btn);
        div.appendChild(fileInput);


        /* --- å®Œäº†ãƒœã‚¿ãƒ³ --- */
        const okBtn = document.createElement("button");
        okBtn.className = "btn-small";
        okBtn.textContent = "ç¢ºèªã—ã¦OK";
        okBtn.onclick = () => {
            bingoData[index].completed = true;
            saveData();
            render();
        };
        div.appendChild(okBtn);


        board.appendChild(div);
    });
}


/* ================================
   ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
================================ */
function exportData() {
    const name = document.getElementById("usernameInput").value;

    const exportObj = {
        userName: name,
        bingoData: []
    };

    Promise.all(
        bingoData.map((cell, index) =>
            getImageFromDB(index).then(imgData => ({
                keyword: cell.keyword,
                image: imgData || null,
                completed: cell.completed
            }))
        )
    ).then(results => {
        exportObj.bingoData = results;

        const blob = new Blob([JSON.stringify(exportObj, null, 2)], { type: "application/json" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `${name || "photoBingo_export"}_bingo4x4.json`; // ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’ãƒ•ã‚¡ã‚¤ãƒ«åã¨ã—ã¦è¨­å®š
        a.click();
    });
}


/* ================================
   ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
================================ */
function importData(event) {
    const file = event.target.files?.[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = () => {
        const obj = JSON.parse(reader.result);

        if (obj.userName) {
            document.getElementById("usernameInput").value = obj.userName;
            localStorage.setItem("photoBingoUserName", obj.userName);
        }

        bingoData = obj.bingoData.map((item, index) => {
            // IndexedDB ã«ä¿å­˜
            if (item.image) saveImageToDB(index, item.image);

            return {
                keyword: item.keyword,
                image: item.image ? true : null,
                completed: item.completed
            };
        });

        saveData();
        render();
        alert("ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†ï¼");
    };

    reader.readAsText(file);
}


/* ================================
   åˆæœŸåŒ–
================================ */
loadData();
render();
loadUserName();
</script>

</body>
</html>


